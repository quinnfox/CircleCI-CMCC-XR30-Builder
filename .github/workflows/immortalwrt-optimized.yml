name: ImmortalWrt Builder (Optimized)

on:
    repository_dispatch:
    workflow_dispatch:
        inputs:
            APP_MTK:
                description: 'Use luci-app-mtk wifi config'
                required: true
                default: false
                type: boolean
            OPTIMIZATION_LEVEL:
                description: 'Optimization level: basic (LTO+MOLD), full (LTO+MOLD+BPF+CLANG), advanced (all optimizations), custom (manual)'
                required: false
                default: 'full'
                type: choice
                options:
                - 'basic'
                - 'full'
                - 'advanced'
                - 'custom'
            ENABLE_LTO:
                description: '[Custom Mode] Enable Link Time Optimization'
                required: false
                default: true
                type: boolean
            ENABLE_MOLD:
                description: '[Custom Mode] Enable MOLD linker (faster compilation)'
                required: false
                default: true
                type: boolean
            ENABLE_BPF:
                description: '[Custom Mode] Enable extended BPF support'
                required: false
                default: true
                type: boolean
            KERNEL_CLANG_LTO:
                description: '[Custom Mode] Enable Kernel CLANG LTO'
                required: false
                default: true
                type: boolean
            USE_GCC14:
                description: '[Custom Mode] Use GCC 14 for userspace compilation'
                required: false
                default: true
                type: boolean
            ENABLE_ADVANCED_FEATURES:
                description: '[Custom Mode] Enable advanced features (LRNG+DPDK+Local KMOD)'
                required: false
                default: false
                type: boolean
            CUSTOM_LAN_IP:
                description: 'Custom LAN IP address (default: 192.168.3.1, replaces ImmortalWrt default 192.168.6.1)'
                required: false
                default: '192.168.3.1'
                type: string

env:
    TZ: Asia/Shanghai
    REPO_URL: https://github.com/padavanonly/immortalwrt-mt798x-6.6
    REPO_BRANCH: openwrt-24.10-6.6
    OPENWRT_NAME: padavanonly
    UPLOAD_TAG_NAME: cmcc_xr30
    FEEDS_CONF: feeds.conf.default
    # CONFIG_FILE: .config
    DIY_P1_SH: diy-part1.sh
    DIY_P2_SH: diy-part2-optimized.sh
    
    # Optimization flags
    OPTIMIZATION_LEVEL: ${{ github.event.inputs.OPTIMIZATION_LEVEL || 'full' }}
    # Individual optimization settings (only used in custom mode)
    ENABLE_LTO: ${{ github.event.inputs.ENABLE_LTO || 'true' }}
    ENABLE_MOLD: ${{ github.event.inputs.ENABLE_MOLD || 'true' }}
    ENABLE_BPF: ${{ github.event.inputs.ENABLE_BPF || 'true' }}
    KERNEL_CLANG_LTO: ${{ github.event.inputs.KERNEL_CLANG_LTO || 'true' }}
    USE_GCC14: ${{ github.event.inputs.USE_GCC14 || 'true' }}
    ENABLE_ADVANCED_FEATURES: ${{ github.event.inputs.ENABLE_ADVANCED_FEATURES || 'false' }}
    CUSTOM_LAN_IP: ${{ github.event.inputs.CUSTOM_LAN_IP || '192.168.3.1' }}

jobs:
    ImmortalWrt-Builder-Optimized:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@main
            
            - name: Check space usage
              if: (!cancelled())
              run: df -hT

            - name: Free disk space (Ubuntu)
              uses: jlumbroso/free-disk-space@main
              with:
                # this might remove tools that are actually needed,
                # if set to "true" but frees about 6 GB
                tool-cache: false

                # all of these default to true, but feel free to set to
                # "false" if necessary for your workflow
                android: true
                dotnet: true
                haskell: true
                large-packages: true
                docker-images: true
                swap-storage: true

            - name: Check space usage
              if: (!cancelled())
              run: df -hT

            - name: Initialization environment
              id: init
              env:
                DEBIAN_FRONTEND: noninteractive
              run: |
                sudo -E apt-get -qq update
                # Install build dependencies including mold
                sudo apt-get install golang-go mold libisl-dev -y
                sudo bash -c 'bash <(curl -s https://build-scripts.immortalwrt.org/init_build_environment.sh)'
                
                # Install additional optimization tools
                if [ "${{ env.USE_GCC14 }}" = "true" ]; then
                  sudo apt-get install gcc-14 g++-14 -y
                  sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-14 100
                  sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-14 100
                fi
                
                sudo -E apt-get -qq autoremove --purge
                sudo -E apt-get -qq clean
                sudo timedatectl set-timezone "$TZ"
                sudo mkdir -p /workdir
                sudo chown $USER:$GROUPS /workdir
                
                # Print optimization settings
                echo "üöÄ Build Optimization Settings:"
                echo "  ENABLE_LTO: ${{ env.ENABLE_LTO }}"
                echo "  ENABLE_MOLD: ${{ env.ENABLE_MOLD }}"
                echo "  ENABLE_BPF: ${{ env.ENABLE_BPF }}"
                echo "  KERNEL_CLANG_LTO: ${{ env.KERNEL_CLANG_LTO }}"
                echo "  USE_GCC14: ${{ env.USE_GCC14 }}"
                echo "  ENABLE_LRNG: ${{ env.ENABLE_LRNG }}"
                echo "  ENABLE_DPDK: ${{ env.ENABLE_DPDK }}"
                echo "  ENABLE_LOCAL_KMOD: ${{ env.ENABLE_LOCAL_KMOD }}"
                
                echo "status=success" >> $GITHUB_OUTPUT

            - name: Clone source code
              id: clone
              if: steps.init.outcome == 'success' && !cancelled()
              working-directory: /workdir
              run: |
                df -hT $PWD
                git clone -b $REPO_BRANCH --single-branch --depth 1 $REPO_URL openwrt
                ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt
                echo "status=success" >> $GITHUB_OUTPUT

            - name: Load custom feeds & execute diy-part1.sh
              id: feeds
              if: steps.clone.outcome == 'success' && !cancelled()
              run: |
                # [ -e $FEEDS_CONF ] && mv $FEEDS_CONF openwrt/feeds.conf.default
                chmod +x $DIY_P1_SH
                cd openwrt
                $GITHUB_WORKSPACE/$DIY_P1_SH
                echo "status=success" >> $GITHUB_OUTPUT

            - name: Update & install feeds
              id: feeds-update
              if: steps.feeds.outcome == 'success' && !cancelled()
              run: |
                cd openwrt
                ./scripts/feeds update -a
                ./scripts/feeds install -a
                echo "status=success" >> $GITHUB_OUTPUT

            - name: Move config & execute diy-part2.sh
              id: config
              if: steps.feeds-update.outcome == 'success' && !cancelled()
              run: |
                    cp -f openwrt/defconfig/mt7981-ax3000.config openwrt/.config
                    chmod +x $DIY_P2_SH
                    cd openwrt
                    $GITHUB_WORKSPACE/$DIY_P2_SH
                    echo "status=success" >> $GITHUB_OUTPUT

            - name: config build dir override
              id: update_config_build
              if: steps.feeds-update.outcome == 'success' && !cancelled()
              run: |
                cd openwrt

                sudo mkdir -p /mnt/openwrt_build
                sudo chmod 775 /mnt/openwrt_build
                # 4. ÊµãËØïÂÜôÂÖ•ÊùÉÈôêÔºàÂÖ≥ÈîÆÔºâ
                sudo touch /mnt/openwrt_build/test.txt
                if [ $? -eq 0 ]; then
                  echo "Ë∑ØÂæÑÊùÉÈôêÊ≠£Â∏∏"
                  sudo rm /mnt/openwrt_build/test.txt
                else
                  echo "Ë∑ØÂæÑÊó†ÂÜôÂÖ•ÊùÉÈôêÔºåÊ£ÄÊü•ÊåÇËΩΩ/ÊùÉÈôê"
                fi
                
                # ÂÆâÂÖ®ËÆæÁΩÆÊûÑÂª∫ÁõÆÂΩïË¶ÜÁõñÈÄâÈ°π
                if [ -f ".config" ]; then
                    # Ê£ÄÊü•ÈÖçÁΩÆÊòØÂê¶Â∑≤Â≠òÂú®ÔºàÂåÖÊã¨Ë¢´Ê≥®ÈáäÁöÑÊÉÖÂÜµÔºâ
                    if grep -q "^CONFIG_BUILD_DIR_OVERRIDE=" .config; then
                        # Â∑≤ÂêØÁî®ÁöÑÈÖçÁΩÆÔºåÁõ¥Êé•Êõ¥Êñ∞
                        sed -i 's/^CONFIG_BUILD_DIR_OVERRIDE=.*/CONFIG_BUILD_DIR_OVERRIDE="\/mnt\/openwrt_build"/' .config
                        echo "Â∑≤Êõ¥Êñ∞ÊûÑÂª∫ÁõÆÂΩï/mnt/openwrt_buildË¶ÜÁõñÈÄâÈ°π"
                    elif grep -q "# CONFIG_BUILD_DIR_OVERRIDE is not set" .config; then
                        # Ë¢´Ê≥®ÈáäÁöÑÈÖçÁΩÆÔºåÂèñÊ∂àÊ≥®ÈáäÂπ∂ËÆæÁΩÆÂÄº
                        sed -i 's/^# CONFIG_BUILD_DIR_OVERRIDE is not set$/CONFIG_BUILD_DIR_OVERRIDE="\/mnt\/openwrt_build"/' .config
                        echo "Â∑≤ÂêØÁî®Âπ∂Êõ¥Êñ∞ÊûÑÂª∫ÁõÆÂΩï/mnt/openwrt_buildË¶ÜÁõñÈÄâÈ°π"
                    else
                        # ÈÖçÁΩÆ‰∏çÂ≠òÂú®ÔºåÊ∑ªÂä†Êñ∞ÈÖçÁΩÆ
                        echo 'CONFIG_BUILD_DIR_OVERRIDE="/mnt/openwrt_build"' >> .config
                        echo "Â∑≤Ê∑ªÂä†ÊûÑÂª∫ÁõÆÂΩï/mnt/openwrt_buildË¶ÜÁõñÈÄâÈ°π"
                    fi
                else
                    echo "Êú™ÊâæÂà∞ÈÖçÁΩÆÊñá‰ª∂.config"
                fi

            - name: docker config
              id: docker_config
              if: steps.feeds-update.outcome == 'success' && !cancelled()
              run: |
                cd openwrt

                # ÂÆö‰πâË¶ÅËøΩÂä†ÁöÑÈÖçÁΩÆÂÜÖÂÆπÔºàÈÅøÂÖçÊâãÂä®ËæìÂÖ•ÈîôËØØÔºâ
                cat << 'EOF' >> .config
                # ÂÜÖÊ†∏ÂøÖÈúÄÈ°πÔºàDocker‰æùËµñÔºâ
                CONFIG_KERNEL_CGROUPS=y
                CONFIG_KERNEL_CGROUP_MEM_RES_CTLR=y
                CONFIG_KERNEL_CGROUP_PIDS=y
                CONFIG_KERNEL_NAMESPACES=y
                CONFIG_KERNEL_OVERLAY_FS=y       # Â≠òÂÇ®È©±Âä®overlay2ÈúÄË¶Å
                CONFIG_KERNEL_BRIDGE=y
                CONFIG_KERNEL_VETH=y             # ËôöÊãüÁΩëÂç°ÔºåDockerÁΩëÁªúÈúÄË¶Å
                
                # DockerÊ†∏ÂøÉÁªÑ‰ª∂
                CONFIG_PACKAGE_docker=y
                CONFIG_PACKAGE_docker-ce=y       # ‰ºòÂÖàÈÄâdocker-ceÔºàËã•Êó†ÂàôÂè™‰øùÁïôdockerÔºâ
                CONFIG_PACKAGE_containerd=y
                CONFIG_PACKAGE_runc=y
                CONFIG_PACKAGE_docker-compose=y  # ÂèØÈÄâÔºåÊåâÈúÄÊ∑ªÂä†
                
                # ‰æùËµñÂ∑•ÂÖ∑
                CONFIG_PACKAGE_bridge-utils=y
                CONFIG_PACKAGE_iptables=y
                CONFIG_PACKAGE_ebtables=y
                CONFIG_PACKAGE_kmod-br-netfilter=y  # Ê°•Êé•ÁΩëÁªúËøáÊª§
                EOF
            
            - name: Use luci-app-mtk config
              if: github.event.inputs.APP_MTK == 'true'
              run: |
                cd openwrt
                sed -i 's/CONFIG_PACKAGE_luci-app-mtwifi-cfg=y/CONFIG_PACKAGE_luci-app-mtk=y/g' .config
                sed -i 's/CONFIG_PACKAGE_luci-i18n-mtwifi-cfg-zh-cn=y/CONFIG_PACKAGE_luci-i18n-mtk-zh-cn=y/g' .config
                sed -i 's/CONFIG_PACKAGE_mtwifi-cfg=y/CONFIG_PACKAGE_wifi-profile=y/g' .config
                sed -i 's/CONFIG_PACKAGE_lua-cjson=y/CONFIG_WIFI_NORMAL_SETTING=y/g' .config

            - name: cat config
              if: steps.config.outcome == 'success' && !cancelled()
              run: |
                  cd openwrt
                  # ÂéªÈáçÔºö‰øùÁïôÊØè‰∏™ÈÖçÁΩÆÈ°πÁöÑÊúÄÂêé‰∏ÄÊ¨°ÂÆö‰πâÔºàÁ¨¶ÂêàOpenWRTÈÖçÁΩÆËßÑÂàôÔºâ
                  awk -F '=' '!a[$1]++' .config > .config.tmp && mv .config.tmp .config
                
                  # ÁßªÈô§Ê≥®ÈáäË°åÂíåÁ©∫Ë°åÔºàÂèØÈÄâÔºåËÆ©.configÊõ¥Êï¥Ê¥ÅÔºâ
                  sed -i '/^#/d; /^$/d' .config
                
                  echo "Êü•Áúã.configÂÜÖÂÆπÔºö"
                  cat .config

            - name: Download package
              id: package
              if: steps.config.outcome == 'success' && !cancelled()
              run: |
                cd openwrt
                make defconfig
                
                # Use optimized parallel download
                CORES=$(nproc)
                JOBS=$((CORES + 1))
                echo "üöÄ Using ${JOBS} parallel jobs for download (${CORES} cores detected)"
                make download -j${JOBS}
                find dl -size -1024c -exec ls -l {} \;
                find dl -size -1024c -exec rm -f {} \;


            - name: Cache ccache
              uses: actions/cache@v4
              with:
                path: /workdir/openwrt/.ccache
                key: ${{ runner.os }}-openwrt-ccache-${{ env.REPO_BRANCH }}-${{ github.sha }}
                # Â¶ÇÊûúÊâæ‰∏çÂà∞ÂÆåÂÖ®ÂåπÈÖçÁöÑ shaÔºåÂõûÈÄÄ‰ΩøÁî®ÊúÄËøëÁöÑÁºìÂ≠ò
                restore-keys: |
                  ${{ runner.os }}-openwrt-ccache-${{ env.REPO_BRANCH }}-
      
            - name: Compile the firmware
              id: compile
              run: |
                cd openwrt
                echo "DEBUG: HOST_CFLAGS is $HOST_CFLAGS"
                CORES=$(nproc)
                JOBS=$((CORES + 1))
                
                echo "üöÄ Starting optimized compilation with ${JOBS} parallel jobs"
                echo "Build optimizations enabled:"
                echo "  - LTO: ${{ env.ENABLE_LTO }}"
                echo "  - MOLD: ${{ env.ENABLE_MOLD }}"
                echo "  - BPF: ${{ env.ENABLE_BPF }}"
                echo "  - Kernel CLANG LTO: ${{ env.KERNEL_CLANG_LTO }}"
                echo "  - GCC14: ${{ env.USE_GCC14 }}"
                echo "  - LRNG: ${{ env.ENABLE_LRNG }}"
                echo "  - DPDK: ${{ env.ENABLE_DPDK }}"
                echo "  - Local KMOD: ${{ env.ENABLE_LOCAL_KMOD }}"
                
                # Record build start time
                BUILD_START=$(date +%s)

                # ÂÆöÊúüÊ£ÄÊü•Á£ÅÁõòÁ©∫Èó¥ÁöÑÂêéÂè∞‰ªªÂä°
                (
                  while pgrep -f "make.*-j" > /dev/null; do
                    sleep 60  # ÊØè1ÂàÜÈíüÊ£ÄÊü•‰∏ÄÊ¨°ÔºàÂéü2ÂàÜÈíüÔºå‰ºòÂåñÂìçÂ∫îÈÄüÂ∫¶Ôºâ
                    echo "üîç Disk usage during compilation (timestamp: $(date)):"
                    df -hT | grep -E '(/dev/root|/mnt)'  # ÊòæÁ§∫Á£ÅÁõòÊï¥‰Ωì‰ΩøÁî®Áéá
                    usage=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
                    
                    if [ "$usage" -gt 80 ]; then
                      echo "‚ö†Ô∏è Disk usage >80%! Searching for large directories (top 10)..."
                      # Êü•ÊâæÁºñËØëÊ†∏ÂøÉÁõÆÂΩï‰∏ãÊúÄÂ§ßÁöÑ10‰∏™ÁõÆÂΩïÔºàÊåâÂ§ßÂ∞èÊéíÂ∫èÔºåÊòæÁ§∫‰∫∫Á±ªÂèØËØªÊ†ºÂºèÔºâ
                      sudo du -h --max-depth=1 /workdir/openwrt 2>/dev/null | sort -hr | head -10
                      echo "üíæ Top 10 largest directories listed above. Starting cleanup..."
                      
                      # ÂéüÊúâÊ∏ÖÁêÜÈÄªËæë‰øùÁïôÔºåÊñ∞Â¢ûÊ∏ÖÁêÜÂ§ßÁõÆÂΩï‰∏ãÁöÑÂÜó‰ΩôÊñá‰ª∂
                      # 1. Ê∏ÖÁêÜLTO‰∏¥Êó∂Êñá‰ª∂„ÄÅÁõÆÊ†áÊñá‰ª∂„ÄÅÈùôÊÄÅÂ∫ì
                      find /workdir/openwrt/build_dir -name "*.ir" -o -name "*.o" -o -name "*.a" -o -name ".libs" -exec rm -rf {} + 2>/dev/null || true
                      # 2. Ê∏ÖÁêÜËøáÊúü‰∏ãËΩΩÂåÖÔºàdlÁõÆÂΩï‰∏ã1Â§©ÂâçÁöÑÊñá‰ª∂Ôºâ
                      find /workdir/openwrt/dl -type f -mtime +1 -exec rm -f {} + 2>/dev/null || true
                      # 3. Ê∏ÖÁêÜccacheËøáÊúüÁºìÂ≠ò
                      ccache -c 2>/dev/null || true
                      # 4. Ê∏ÖÁêÜstaging_dir‰∏ãÁöÑÂÜó‰ΩôÂ§¥Êñá‰ª∂ÂíåÂ∫ìÊñá‰ª∂
                      rm -rf /workdir/openwrt/staging_dir/target-*/*/lib/*.a 2>/dev/null || true
                      rm -rf /workdir/openwrt/staging_dir/toolchain-*/*/include/* 2>/dev/null || true
                
                      rm -rf /workdir/openwrt/*.log
                      # Âà†Èô§openwrtÊ†πÁõÆÂΩïÁöÑ.gitÁõÆÂΩï
                      rm -rf /workdir/data/openwrt/.git
                      # Ëã•feedsÁõÆÂΩï‰πüÊúâ.gitÔºåÂèØ‰∏ÄÂπ∂Âà†Èô§Ôºà‰ªÖÈáäÊîæÂ∞ëÈáèÁ©∫Èó¥Ôºâ
                      rm -rf /workdir/data/openwrt/feeds/*/.git                
                      
                      echo "‚úÖ Cleanup completed. Updated disk usage:"
                      df -hT | grep -E '(/dev/root|/mnt)'
                    fi
                  done
                ) &
                
                # Optimized build process
                make -j${JOBS} 2> >(tee build-error.log) >/dev/null || make -j1 2> >(tee -a build-error.log) >/dev/null || make -j1 V=s 2> >(tee -a build-error.log) >/dev/null
                
                # Calculate build time
                BUILD_END=$(date +%s)
                BUILD_TIME=$((BUILD_END - BUILD_START))
                BUILD_MINUTES=$((BUILD_TIME / 60))
                BUILD_SECONDS=$((BUILD_TIME % 60))
                echo "‚è±Ô∏è Build completed in ${BUILD_MINUTES}m ${BUILD_SECONDS}s"
                
                if grep -q 'CONFIG_PACKAGE_mtwifi-cfg=y' .config; then
                        echo "WIFI_INTERFACE=-mtwifi" >> $GITHUB_ENV
                else
                echo "WIFI_INTERFACE=" >> $GITHUB_ENV
                fi
                echo "COMPILE_DATE=$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV
                echo "status=success" >> $GITHUB_OUTPUT

            # ==============================================
            # Ê†∏ÂøÉÊñ∞Â¢ûÔºöÁºñËØëÂ§±Ë¥•ÂêéÊâßË°åÁ£ÅÁõòÁ©∫Èó¥Ê£ÄÊü• + Êó•ÂøóÊî∂ÈõÜ
            # ==============================================
            - name: Collect debug info on failure (Disk Space + Logs)
              id: collect-debug
              if: failure()  # Âè™ÊúâÂâçÈù¢Ê≠•È™§Â§±Ë¥•Êó∂ÊâçÊâßË°å
              run: |
                echo "=============================================="
                echo "‚ùå Build failed! Collecting debug information..."
                echo "=============================================="
                
                # 1. Ê£ÄÊü•Á£ÅÁõòÁ©∫Èó¥ÔºàÂÖ≥ÈîÆÔºöÊéíÊü•Á£ÅÁõò‰∏çË∂≥ÈóÆÈ¢òÔºâ
                echo "üìä Disk Space Usage:"
                df -hT
                echo ""
                
                # 2. Ê£ÄÊü•ÂÜÖÂ≠òÂíå‰∫§Êç¢Á©∫Èó¥ÔºàÂÖ≥ÈîÆÔºöÊéíÊü•OOMÈóÆÈ¢òÔºâ
                echo "üìä Memory & Swap Usage:"
                free -h
                echo ""

                # ÁºñËØëÂô®‰ø°ÊÅØ
                echo "üîç Compiler Info:"
                gcc --version
                cc --version
                which gcc
                which cc
                echo ""          
                
                # 3. Ê£ÄÊü•ÂΩìÂâçÂ∑•‰ΩúÁõÆÂΩïÊùÉÈôêÔºà‰øÆÂ§çÔºöÂÖàÂà§Êñ≠ÁõÆÂΩïÊòØÂê¶Â≠òÂú®Ôºâ
                echo "üîç Work Directory Permissions:"
                if [ -d "/workdir" ]; then
                  ls -la /workdir
                else
                  echo "‚ö†Ô∏è /workdir does not exist (initialization step failed)"
                fi
                echo ""
                
                # 4. ÂàõÂª∫Êó•ÂøóÁõÆÂΩï
                mkdir -p $GITHUB_WORKSPACE/debug-logs
                
                # 5. Êî∂ÈõÜ m4 Â∑•ÂÖ∑ÁöÑ config.logÔºàÂÖ≥ÈîÆÔºöÊéíÊü• tools/m4 ÁºñËØëÂ§±Ë¥•Ôºâ
                echo "üìÑ Collecting m4 config.log..."
                if [ -d "/workdir/openwrt" ]; then
                  M4_CONFIG_LOG=$(find /workdir/openwrt/build_dir/host/m4-* -name config.log 2>/dev/null | head -1)
                  if [ -f "$M4_CONFIG_LOG" ]; then
                    cp "$M4_CONFIG_LOG" $GITHUB_WORKSPACE/debug-logs/m4-config.log
                    echo "‚úÖ m4 config.log collected"
                  else
                    echo "‚ö†Ô∏è m4 config.log not found"
                    echo "m4 config.log not found" > $GITHUB_WORKSPACE/debug-logs/m4-config.log
                  fi
                else
                  echo "‚ö†Ô∏è /workdir/openwrt does not exist (clone step failed)"
                  echo "m4 config.log not available (source code not cloned)" > $GITHUB_WORKSPACE/debug-logs/m4-config.log
                fi
                
                # 6. Êî∂ÈõÜÁºñËØëËøáÁ®ã‰∏≠ÁöÑÂÖ≥ÈîÆÊó•ÂøóÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
                echo "üìÑ Collecting build logs..."
                if [ -d "/workdir/openwrt" ]; then
                  find /workdir/openwrt -name "*.log" -type f -size -10M | head -10 | xargs -I {} cp {} $GITHUB_WORKSPACE/debug-logs/ 2>/dev/null || true
                else
                  echo "‚ö†Ô∏è No build logs available (source code not cloned)"
                fi
                
                # 7. Êî∂ÈõÜ .config Êñá‰ª∂ÔºàÊéíÊü•ÈÖçÁΩÆÈîôËØØÔºâ
                echo "üìÑ Collecting .config file..."
                if [ -f "/workdir/openwrt/.config" ]; then
                  cp /workdir/openwrt/.config $GITHUB_WORKSPACE/debug-logs/.config
                else
                  echo "‚ö†Ô∏è .config file not found (config step failed)"
                  echo ".config file not available" > $GITHUB_WORKSPACE/debug-logs/.config
                fi
                
                # 8. Êî∂ÈõÜÁ£ÅÁõòÁ©∫Èó¥ÂíåÂÜÖÂ≠ò‰ΩøÁî®ÊÉÖÂÜµÁöÑÊó•Âøó
                echo "üìÑ Saving system info to log..."
                df -hT > $GITHUB_WORKSPACE/debug-logs/disk-space.log
                free -h > $GITHUB_WORKSPACE/debug-logs/memory.log
                
                # 9. ÂàóÂá∫Êî∂ÈõÜÂà∞ÁöÑÊó•ÂøóÊñá‰ª∂
                echo "üìã Collected debug logs:"
                ls -la $GITHUB_WORKSPACE/debug-logs
                echo ""

                cat build-error.log    
                          
                echo "‚úÖ Debug information collection completed"



            - name: Check space usage
              if: (!cancelled())
              run: df -hT

            - name: Organize compiled firmware
              if: steps.compile.outcome == 'success' && !cancelled()
              run: |
                mapfile -t devices < <(grep '^CONFIG_TARGET_DEVICE.*=y' openwrt/.config | sed -r 's/.*DEVICE_(.*)=y/\1/')
                cd openwrt/bin/targets/*/*
                
                echo "üìã Ê£ÄÊü•ÊûÑÂª∫ÁªìÊûú..."
                echo "ÁîüÊàêÁöÑÊâÄÊúâÊñá‰ª∂Ôºö"
                ls -la
                echo ""
                
                echo "Êü•Êâæ CMCC XR30 Áõ∏ÂÖ≥Êñá‰ª∂Ôºö"
                find . -name "*cmcc*" -o -name "*xr30*" || echo "‚ö†Ô∏è Êú™ÊâæÂà∞ CMCC XR30 Êñá‰ª∂"
                echo ""
                
                # Check if XR30 firmware was generated
                if ! find . -name "*cmcc_xr30*sysupgrade.bin" | grep -q .; then
                    echo "‚ùå Ë≠¶ÂëäÔºöÊú™ÊâæÂà∞ CMCC XR30 ÂçáÁ∫ßÂõ∫‰ª∂"
                    echo "üìã ÊâÄÊúâÁîüÊàêÁöÑ .bin Êñá‰ª∂Ôºö"
                    find . -name "*.bin" | head -10
                    echo ""
                fi
                
                rm -rf packages
                sudo -E apt-get -qq install rename
                for val in "${devices[@]}"; do
                    rename "s/.*${val}/${{ env.COMPILE_DATE }}-${{ env.OPENWRT_NAME }}-${val}${{ env.WIFI_INTERFACE }}/" *
                    echo "$val"
                done
                echo "FIRMWARE=$PWD" >> $GITHUB_ENV
                echo "status=success" >> $GITHUB_OUTPUT

            - name: Upload firmware to Artifacts
              # if: steps.organize.outcome == 'success' && !cancelled()
              uses: actions/upload-artifact@main
              with:
                name: ${{ env.COMPILE_DATE }}-${{ env.OPENWRT_NAME }}-${{ env.UPLOAD_TAG_NAME }}${{ env.WIFI_INTERFACE }}
                path: |
                  /workdir/openwrt/bin/targets/*/*/*.bin
                  /workdir/openwrt/bin/targets/*/*/*.manifest
                  /workdir/openwrt/bin/targets/*/*/sha256sums
                  /workdir/openwrt/bin/targets/*/*/*buildinfo
