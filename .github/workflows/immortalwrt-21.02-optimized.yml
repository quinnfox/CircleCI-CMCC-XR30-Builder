name: ImmortalWrt 21.02 Builder (Optimized)

on:
    repository_dispatch:
    workflow_dispatch:
        inputs:
            APP_MTK:
                description: 'Use luci-app-mtk wifi config'
                required: true
                default: false
                type: boolean
            OPTIMIZATION_LEVEL:
                description: 'Optimization level: basic (LTO+MOLD), full (LTO+MOLD+BPF+CLANG), advanced (all optimizations), custom (manual)'
                required: false
                default: 'full'
                type: choice
                options:
                - 'basic'
                - 'full'
                - 'advanced'
                - 'custom'
            ENABLE_LTO:
                description: '[Custom Mode] Enable Link Time Optimization'
                required: false
                default: true
                type: boolean
            ENABLE_MOLD:
                description: '[Custom Mode] Enable MOLD linker (faster compilation)'
                required: false
                default: true
                type: boolean
            # ENABLE_BPF:
            #     description: '[Custom Mode] Enable extended BPF support'
            #     required: false
            #     default: true
            #     type: boolean
            KERNEL_CLANG_LTO:
                description: '[Custom Mode] Enable Kernel CLANG LTO'
                required: false
                default: true
                type: boolean
            USE_GCC14:
                description: '[Custom Mode] Use GCC 14 for userspace compilation'
                required: false
                default: true
                type: boolean
            ENABLE_ADVANCED_FEATURES:
                description: '[Custom Mode] Enable advanced features (LRNG+DPDK+Local KMOD)'
                required: false
                default: false
                type: boolean
            CUSTOM_LAN_IP:
                description: 'Custom LAN IP address (default: 192.168.3.1, replaces ImmortalWrt default 192.168.1.1)'
                required: false
                default: '192.168.3.1'
                type: string

env:
    TZ: Asia/Shanghai
    REPO_URL: https://github.com/hanwckf/immortalwrt-mt798x
    REPO_BRANCH: openwrt-21.02
    OPENWRT_NAME: hanwckf
    UPLOAD_TAG_NAME: cmcc_xr30
    FEEDS_CONF: feeds.21.02.conf.default
    # CONFIG_FILE: .config
    DIY_P1_SH: diy-part1.sh
    DIY_P2_SH: diy-part2-21.02-optimized.sh
    
    # Optimization flags
    OPTIMIZATION_LEVEL: ${{ github.event.inputs.OPTIMIZATION_LEVEL || 'full' }}
    # Individual optimization settings (only used in custom mode)
    ENABLE_LTO: ${{ github.event.inputs.ENABLE_LTO || 'true' }}
    ENABLE_MOLD: ${{ github.event.inputs.ENABLE_MOLD || 'true' }}
    # ENABLE_BPF: ${{ github.event.inputs.ENABLE_BPF || 'true' }}
    KERNEL_CLANG_LTO: ${{ github.event.inputs.KERNEL_CLANG_LTO || 'true' }}
    USE_GCC14: ${{ github.event.inputs.USE_GCC14 || 'true' }}
    ENABLE_ADVANCED_FEATURES: ${{ github.event.inputs.ENABLE_ADVANCED_FEATURES || 'false' }}
    CUSTOM_LAN_IP: ${{ github.event.inputs.CUSTOM_LAN_IP || '192.168.3.1' }}

jobs:
    ImmortalWrt-Builder-Optimized:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@main
            
            - name: Check space usage
              if: (!cancelled())
              run: df -hT

            - name: Free disk space (Ubuntu)
              uses: jlumbroso/free-disk-space@main
              with:
                # this might remove tools that are actually needed,
                # if set to "true" but frees about 6 GB
                tool-cache: false

                # all of these default to true, but feel free to set to
                # "false" if necessary for your workflow
                android: true
                dotnet: true
                haskell: true
                large-packages: true
                docker-images: true
                swap-storage: true

            - name: Check space usage
              if: (!cancelled())
              run: df -hT

            - name: Initialization environment
              id: init
              env:
                DEBIAN_FRONTEND: noninteractive
              run: |
                sudo -E apt-get -qq update
                # Install build dependencies including mold
                sudo apt-get install golang-go mold -y
                sudo bash -c 'bash <(curl -s https://build-scripts.immortalwrt.org/init_build_environment.sh)'
                
                # Install additional optimization tools
                if [ "${{ env.USE_GCC14 }}" = "true" ]; then
                  sudo apt-get install gcc-14 g++-14 -y
                  sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-14 100
                  sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-14 100
                fi
                
                sudo -E apt-get -qq autoremove --purge
                sudo -E apt-get -qq clean
                sudo timedatectl set-timezone "$TZ"
                sudo mkdir -p /workdir
                sudo chown $USER:$GROUPS /workdir
                
                # Print optimization settings
                echo "ðŸš€ Build Optimization Settings:"
                echo "  ENABLE_LTO: ${{ env.ENABLE_LTO }}"
                echo "  ENABLE_MOLD: ${{ env.ENABLE_MOLD }}"
                # echo "  ENABLE_BPF: ${{ env.ENABLE_BPF }}"
                echo "  KERNEL_CLANG_LTO: ${{ env.KERNEL_CLANG_LTO }}"
                echo "  USE_GCC14: ${{ env.USE_GCC14 }}"
                # echo "  ENABLE_LRNG: ${{ env.ENABLE_LRNG }}"
                # echo "  ENABLE_DPDK: ${{ env.ENABLE_DPDK }}"
                # echo "  ENABLE_LOCAL_KMOD: ${{ env.ENABLE_LOCAL_KMOD }}"
                
                echo "status=success" >> $GITHUB_OUTPUT

            - name: Clone source code
              id: clone
              if: steps.init.outcome == 'success' && !cancelled()
              working-directory: /workdir
              run: |
                df -hT $PWD
                git clone -b $REPO_BRANCH --single-branch --depth 1 $REPO_URL openwrt
                ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt
                echo "status=success" >> $GITHUB_OUTPUT

            - name: Load custom feeds & execute diy-part1.sh
              id: feeds
              if: steps.clone.outcome == 'success' && !cancelled()
              run: |
                [ -e $FEEDS_CONF ] && mv $FEEDS_CONF openwrt/feeds.conf.default
                chmod +x $DIY_P1_SH
                cd openwrt
                $GITHUB_WORKSPACE/$DIY_P1_SH
                echo "status=success" >> $GITHUB_OUTPUT

            - name: Update & install feeds
              id: feeds-update
              if: steps.feeds.outcome == 'success' && !cancelled()
              run: |
                cd openwrt
                ./scripts/feeds update -a
                ./scripts/feeds install -a
                echo "status=success" >> $GITHUB_OUTPUT

            - name: Move config & execute diy-part2.sh
              id: config
              if: steps.feeds-update.outcome == 'success' && !cancelled()
              run: |
                    cp -f openwrt/defconfig/mt7981-ax3000.config openwrt/.config
                    chmod +x $DIY_P2_SH
                    cd openwrt
                    $GITHUB_WORKSPACE/$DIY_P2_SH
                    echo "status=success" >> $GITHUB_OUTPUT
            
            - name: Use luci-app-mtk config
              if: github.event.inputs.APP_MTK == 'true'
              run: |
                cd openwrt
                sed -i 's/CONFIG_PACKAGE_luci-app-mtwifi-cfg=y/CONFIG_PACKAGE_luci-app-mtk=y/g' .config
                sed -i 's/CONFIG_PACKAGE_luci-i18n-mtwifi-cfg-zh-cn=y/CONFIG_PACKAGE_luci-i18n-mtk-zh-cn=y/g' .config
                sed -i 's/CONFIG_PACKAGE_mtwifi-cfg=y/CONFIG_PACKAGE_wifi-profile=y/g' .config
                sed -i 's/CONFIG_PACKAGE_lua-cjson=y/CONFIG_WIFI_NORMAL_SETTING=y/g' .config

            - name: Download package
              id: package
              if: steps.config.outcome == 'success' && !cancelled()
              run: |
                cd openwrt
                make defconfig
                
                # Use optimized parallel download
                CORES=$(nproc)
                JOBS=$((CORES + 1))
                echo "ðŸš€ Using ${JOBS} parallel jobs for download (${CORES} cores detected)"
                make download -j${JOBS}
                find dl -size -1024c -exec ls -l {} \;
                find dl -size -1024c -exec rm -f {} \;

            - name: Compile the firmware
              id: compile
              run: |
                cd openwrt
                CORES=$(nproc)
                JOBS=$((CORES + 1))
                
                echo "ðŸš€ Starting optimized compilation with ${JOBS} parallel jobs"
                echo "Build optimizations enabled:"
                echo "  - LTO: ${{ env.ENABLE_LTO }}"
                echo "  - MOLD: ${{ env.ENABLE_MOLD }}"
                # echo "  - BPF: ${{ env.ENABLE_BPF }}"
                echo "  - Kernel CLANG LTO: ${{ env.KERNEL_CLANG_LTO }}"
                echo "  - GCC14: ${{ env.USE_GCC14 }}"
                # echo "  - LRNG: ${{ env.ENABLE_LRNG }}"
                # echo "  - DPDK: ${{ env.ENABLE_DPDK }}"
                # echo "  - Local KMOD: ${{ env.ENABLE_LOCAL_KMOD }}"
                
                # Record build start time
                BUILD_START=$(date +%s)
                
                # Optimized build process
                make -j${JOBS} V=s || make -j1 || make -j1 V=s
                
                # Calculate build time
                BUILD_END=$(date +%s)
                BUILD_TIME=$((BUILD_END - BUILD_START))
                BUILD_MINUTES=$((BUILD_TIME / 60))
                BUILD_SECONDS=$((BUILD_TIME % 60))
                echo "â±ï¸ Build completed in ${BUILD_MINUTES}m ${BUILD_SECONDS}s"
                
                if grep -q 'CONFIG_PACKAGE_mtwifi-cfg=y' .config; then
                        echo "WIFI_INTERFACE=-mtwifi" >> $GITHUB_ENV
                else
                echo "WIFI_INTERFACE=" >> $GITHUB_ENV
                fi
                echo "COMPILE_DATE=$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV
                echo "status=success" >> $GITHUB_OUTPUT

            - name: Check space usage
              if: (!cancelled())
              run: df -hT

            - name: Organize compiled firmware
              if: steps.compile.outcome == 'success' && !cancelled()
              run: |
                mapfile -t devices < <(grep '^CONFIG_TARGET_DEVICE.*=y' openwrt/.config | sed -r 's/.*DEVICE_(.*)=y/\1/')
                cd openwrt/bin/targets/*/*
                
                echo "ðŸ“‹ æ£€æŸ¥æž„å»ºç»“æžœ..."
                echo "ç”Ÿæˆçš„æ‰€æœ‰æ–‡ä»¶ï¼š"
                ls -la
                echo ""
                
                echo "æŸ¥æ‰¾ CMCC XR30 ç›¸å…³æ–‡ä»¶ï¼š"
                find . -name "*cmcc*" -o -name "*xr30*" || echo "âš ï¸ æœªæ‰¾åˆ° CMCC XR30 æ–‡ä»¶"
                echo ""
                
                # Check if XR30 firmware was generated
                if ! find . -name "*cmcc_xr30*sysupgrade.bin" | grep -q .; then
                    echo "âŒ è­¦å‘Šï¼šæœªæ‰¾åˆ° CMCC XR30 å‡çº§å›ºä»¶"
                    echo "ðŸ“‹ æ‰€æœ‰ç”Ÿæˆçš„ .bin æ–‡ä»¶ï¼š"
                    find . -name "*.bin" | head -10
                    echo ""
                fi
                
                rm -rf packages
                sudo -E apt-get -qq install rename
                for val in "${devices[@]}"; do
                    rename "s/.*${val}/${{ env.COMPILE_DATE }}-${{ env.OPENWRT_NAME }}-${val}${{ env.WIFI_INTERFACE }}/" *
                    echo "$val"
                done
                echo "FIRMWARE=$PWD" >> $GITHUB_ENV
                echo "status=success" >> $GITHUB_OUTPUT

            - name: Upload firmware to Artifacts
              # if: steps.organize.outcome == 'success' && !cancelled()
              uses: actions/upload-artifact@main
              with:
                name: ${{ env.COMPILE_DATE }}-${{ env.OPENWRT_NAME }}-${{ env.UPLOAD_TAG_NAME }}${{ env.WIFI_INTERFACE }}
                path: |
                  /workdir/openwrt/bin/targets/*/*/*.bin
                  /workdir/openwrt/bin/targets/*/*/*.manifest
                  /workdir/openwrt/bin/targets/*/*/sha256sums
                  /workdir/openwrt/bin/targets/*/*/*buildinfo
